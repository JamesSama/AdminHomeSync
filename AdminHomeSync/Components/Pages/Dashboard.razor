@page "/dashboard"
@using AdminHomeSync.Components.Services
@inject IJSRuntime JS
@inject IUserService UserService
@inject DeviceService DeviceService /*for calling connected devices*/
@inject ActivityService ActivityService /*for logging activity list*/
@using static AdminHomeSync.Components.Services.NotificationService
@inject NotificationService NotificationService /*for logging notification messages [2/2]*/

<PageTitle>Dashboard</PageTitle>

<div class="dashboard-page">
    <div class="dashcard">
        <div class="dashtitle">
            <strong>Welcome, Admin {username}!</strong>
            <p>@displayedDate</p>
        </div>
        <div class="grid-container">
            <div class="column left-column">
                <div class="box">
                    <div class="box-header">
                        <div class="header-left">
                            <img src="icon/nav-activity.svg" alt="Activity Icon" class="icon-act" />
                            <div>Recent Activities</div>
                        </div>
                        <a href="/activity" class="nav-link">See all</a>
                    </div>
                    <div class="box-content-container">
                        @if (activities != null && activities.Any())
                        {
                            @foreach (var activity in activities)
                            {
                                <div class="box-content">
                                    <p class="left-act">@activity.Action: @activity.UserName</p>
                                    <p>@activity.DateTime.ToString("MMMM d, yyyy • h:mm tt")</p>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="no-activity-container">
                                <p>No recent activities to display...</p>
                            </div>
                        }
                    </div>
                </div>
                <div class="box">
                    <div class="box-header">
                        <div class="header-left">
                            <img src="icon/nav-notification.svg" alt="Notification Icon" class="icon-notif" />
                            <div>Notifications</div>
                        </div>
                        <a href="/notification" class="nav-link">See all</a>
                    </div>
                    <div class="box-content-container">
                        @if (notifications != null && notifications.Any())
                        {
                            @foreach (var notification in notifications)
                            {
                                <div class="box-content">
                                    <p class="left-notif">@notification.Message</p>
                                    <p>@notification.Date</p>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="no-notif-container">
                                <p>No notifications to display...</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
            <div class="column right-column">
                <div class="box box3">
                    <img src="images/dashboard-illustration 1.png" alt="Dashboard Image" />
                </div>
                <a class="buttons" href="/users">
                    <div class="box box4">
                        <div class="leftboxes">
                            <img src="icon/nav-users.svg" alt="Users Icon" class="icon-users" />
                            Users
                        </div>
                        <div class="rightboxes">@(summation?.TotalUsers ?? 0)</div>
                    </div>
                </a>
                <a class="buttons" href="/devices">
                    <div class="box box5">
                        <div class="leftboxes">
                            <img src="icon/nav-devices.svg" alt="Devices Icon" class="icon-devices" />
                            Connected Devices
                        </div>
                        <div class="rightboxes">@connectedDevicesCount</div>
                    </div>
                </a>
            </div>
        </div>
    </div>
</div>

@code {
    private List<UserActivity> activities = new List<UserActivity>();
    private List<NotificationItem>? notifications;
    private UserSummation? summation;
    private int connectedDevicesCount;
    private string displayedDate = string.Empty;
    private string displayedTime = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        if (OperatingSystem.IsBrowser()) // WebAssembly (client-side)
        {
            // Fetch client (browser) date and time via JavaScript
            await JS.InvokeVoidAsync("getCurrentDateTime", DotNetObjectReference.Create(this));
        }
        else // Blazor Server (server-side)
        {
            // Fetch server date and time separately
            var now = DateTime.Now;
            displayedDate = now.ToString("MMMM d, yyyy"); // Date format: "Month Day, Year"
            displayedTime = now.ToString("hh:mm tt"); // Time format: "hh:mm:ss AM/PM"
        }

        try
        {
            summation = await UserService.GetUserSummationAsync();
        }
        catch (Exception)
        {
            summation = null;
        }

        try
        {
            // Fetch recent activities from Firebase and sort by DateTime
            activities = (await ActivityService.FetchActivitiesFromFirebase())
            .OrderByDescending(a => a.DateTime)
            .ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching activities: {ex.Message}");
            activities = new List<UserActivity>();
        }

        try
        {
            // Fetch user devices
            var userDevices = await DeviceService.GetDevicesDataAsync();

            // Calculate summary counts
            connectedDevicesCount = userDevices.Sum(d =>
            (d.Lights.IsConnected ? 1 : 0) +
            (d.Fan.IsConnected ? 1 : 0) +
            (d.MotionSensor.IsConnected ? 1 : 0));
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching user devices: {ex.Message}");
            connectedDevicesCount = 0;
        }

        notifications = NotificationService.GetNotifications();
    }

    [JSInvokable]
    public void UpdateClientDateTime(string date, string time)
    {
        displayedDate = date;
        displayedTime = time;
    }
}
